name: build

on:
  push:
    tags:
      - 'v*'
  pull_request:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        configuration: [Release]

    runs-on: windows-2022

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2



      - name: Install MFC libraries via Visual Studio bootstrapper
        shell: pwsh
        run: |
          Write-Host "Locating existing Visual Studio installation..."

          # GitHub runners always have VS 2022 Enterprise here
          $vsInstall = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"

          if (-Not (Test-Path $vsInstall)) {
            Write-Host "❌ Could not find Visual Studio installation at $vsInstall"
            exit 1
          }

          Write-Host "Found Visual Studio at: $vsInstall"

          Write-Host "Downloading Visual Studio Build Tools bootstrapper..."
          $vsUrl = "https://aka.ms/vs/17/release/vs_buildtools.exe"
          $vsExe = "$env:TEMP\vs_buildtools.exe"
          Invoke-WebRequest $vsUrl -OutFile $vsExe

          Write-Host "Installing required Visual Studio components into existing installation..."

          & $vsExe `
            --quiet --wait --norestart --nocache `
            --installPath "$vsInstall" `
            --add Microsoft.VisualStudio.Workload.VCTools `
            --add Microsoft.VisualStudio.Component.VC.ATLMFC `
            --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64

          Write-Host "Verifying MFC installation..."

          $mfcPath = Get-ChildItem "$vsInstall\VC\Tools\MSVC\*\atlmfc" -ErrorAction SilentlyContinue

          if ($mfcPath) {
            Write-Host "✅ MFC libraries found at: $($mfcPath.FullName)"
          } else {
            Write-Host "❌ MFC installation failed"
            Write-Host "Contents of MSVC folder:"
            Get-ChildItem "$vsInstall\VC\Tools\MSVC\" -ErrorAction SilentlyContinue
            exit 1
          }



      - name: Run MSBuild with Code Analysis
        run: |
          $msbuildArgs = @(
            "ColorCop.sln"
            "/p:Configuration=${{ matrix.configuration }}"
            "/p:Platform=Win32"
            "/p:RunCodeAnalysis=true"
            "/p:CodeAnalysisRuleSet=NativeMinimumRules.ruleset"
            "/p:CodeAnalysisTreatWarningsAsErrors=false"
          )
          MSBuild.exe $msbuildArgs

      - name: Build x64 Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        if: matrix.configuration == 'Release'
        with:
          path: inno\colorcop.iss
          options: /O+

      - name: Publish Release Artifacts
        uses: actions/upload-artifact@v6
        if: matrix.configuration == 'Release'
        with:
          name: installers
          path: .\output
          retention-days: 30

      - name: Create Flat Zip Archive
        run: |
          Remove-Item -Path "Release-standalone" -Recurse -Force -ErrorAction SilentlyContinue

          New-Item -ItemType Directory -Path "Release-standalone"

          Copy-Item -Path "Release\*.exe" -Destination "Release-standalone"
          Copy-Item -Path "ReadMe.txt" -Destination "Release-standalone"
          Copy-Item -Path "LICENSE.txt" -Destination "Release-standalone"
          Copy-Item -Path "packaging\*.chm" -Destination "Release-standalone"

          Set-Location "Release-standalone"

          Compress-Archive -Path "*" -DestinationPath "../colorcop.zip" -Force
        shell: pwsh

      - name: Publish Release Artifacts
        uses: actions/upload-artifact@v6
        if: matrix.configuration == 'Release'
        with:
          name: colorcop-zip
          path: colorcop.zip
          retention-days: 30

      - name: Release to GitHub Releases
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: |
            colorcop.zip
            output/colorcop-setup.exe
